Task 1 — Backend: classify expired WebHub token

In AuthService.validate_webhub_token(...), when resp.status_code == 404, raise a distinct auth error (e.g. AuthenticationError("SSO_TOKEN_EXPIRED")). Keep the existing behavior for other non-200s.

⸻

Task 2 — Backend: make /auth/bootstrap return loginUrl + error code on 401

In the /auth/bootstrap endpoint, catch that specific AuthenticationError("SSO_TOKEN_EXPIRED") and return:


{ "error": "SSO_TOKEN_EXPIRED", "loginUrl": "<webhub>/api/v1.0/auth/login" }


Also catch the generic “not authenticated / validation failed” case and return:

{ "error": "NOT_AUTHENTICATED", "loginUrl": "<webhub>/api/v1.0/auth/login" }


(Still HTTP 401.)

⸻

Task 3 — Backend: clear PHAR session cookie on bootstrap 401

Before returning either of those 401 JSON responses from /auth/bootstrap, call clear_session_cookie(response) so a stale PHAR cookie can’t keep causing confusing behavior.

⸻

Task 4 — Frontend: treat bootstrap 401 payload as authoritative

In the place where you call PHAR /auth/bootstrap (inside AuthGate), if it throws with status === 401, read e.body.error and e.body.loginUrl. Do not treat all 401s the same anymore.

⸻

Task 5 — Frontend: handle SSO_TOKEN_EXPIRED by hard reset + redirect

If /auth/bootstrap fails with:
	•	error === "SSO_TOKEN_EXPIRED"

then do these in order:
	1.	sessionStorage.removeItem("phar:lastSsoRedirect")
	2.	(optional) keep or reset phar:returnTo (I recommend keeping it)
	3.	set sessionStorage.setItem("phar:lastSsoRedirect", Date.now().toString())
	4.	window.location.assign(loginUrlWithReturnTo)

No retries, no polling.

⸻

Task 6 — Frontend: handle NOT_AUTHENTICATED by redirect (no looping)

If /auth/bootstrap fails with:
	•	error === "NOT_AUTHENTICATED"

then redirect to loginUrlWithReturnTo using the same redirect guard you already have (the 5-second loop protection). Don’t re-call bootstrap in a tight loop.

⸻

Task 7 — Frontend: improve redirect loop protection behavior

Where you currently do:

“if last redirect < 5s, setStatus(‘error’)”

Change it to:
	•	If last redirect was < 5s ago: show loader and stop (no error screen).
This avoids false “Authentication failed” while SSO is bouncing back.

⸻

Task 8 — Frontend: ensure only ONE auth “driver” runs

Make sure AuthGate does not call /auth/bootstrap repeatedly once a redirect has been triggered. After window.location.assign(...), return immediately and don’t continue logic.
